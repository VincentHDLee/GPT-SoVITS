# CUDA 兼容性问题备忘录

本文档记录了在使用 `GPT-SoVITS` 项目时遇到的与 CUDA、PyTorch 和 NVIDIA 显卡相关的兼容性问题，并探讨了相应的解决方案。

## 问题现象

在项目运行过程中，主要遇到了两种与 CUDA 相关的致命错误（`FATAL`）或运行时错误（`RuntimeError`）。

### 现象一：半精度（FP16）推理导致的架构不匹配

- **触发条件**：在开启半精度推理时（默认设置），在某些NVIDIA显卡上（例如 5060 Ti）可能会出现。
- **报错信息**：
  ```
  FATAL: this function is for sm80, but was built for sm370
  ```
- **根本原因**：这是一个典型的CUDA架构不匹配问题。`sm80` 指的是较新的NVIDIA Ampere架构（如RTX 30系列），而 `sm37` 指的是非常老旧的Kepler架构。错误表明，项目 `runtime` 中预编译的PyTorch库在尝试执行一个半精度计算核心时，错误地加载了一个为旧架构编译的函数，导致在现代显卡上执行失败。这通常由 `runtime` 环境与系统NVIDIA驱动之间的深层不兼容导致。

### 现象二：v2Pro模型声纹提取模块编译失败

- **触发条件**：加载 "v2Pro" 或 "v2ProPlus" 类型的GPT模型（例如 `xxx-e5.ckpt`）并进行推理时。
- **报错信息**：
  ```
  Traceback (most recent call last):
    ...
    File "C:\WorkSpace\GPT-SoVITS-v2pro/GPT_SoVITS/eres2net\kaldi.py", line 621, in fbank
      spectrum = torch.fft.rfft(strided_input).abs()
  RuntimeError:
    ...
    nvrtc: error: invalid value for --gpu-architecture (-arch)
  ```
- **根本原因**：v2Pro系列模型会调用一个名为 `eres2net` 的特殊声纹提取模块。该模块依赖PyTorch的**即时编译（JIT）**功能来为当前GPU动态编译计算核心。报错表明，PyTorch的JIT编译器（`nvrtc`）在尝试编译时，未能正确识别出当前GPU的架构代号，或者收到了一个无效的代号，从而导致编译失败和程序崩溃。这同样指向了 `runtime` 环境与硬件驱动之间的兼容性问题。

## 解决方案探讨

### 方案A：手动指定GPU架构（推荐的根本性修复方案）

- **操作**：在程序启动时，通过代码设置环境变量 `os.environ['TORCH_CUDA_ARCH_LIST'] = '8.9'`（`8.9` 是 Ada Lovelace 架构如 4060 Ti 的代号，`8.6` 是 Ampere 架构如 3060 Ti 的代号）。
- **优点**：直击问题核心，明确告知PyTorch应为哪个架构编译代码，可以从根源上解决JIT编译失败的问题，且不牺牲任何功能。
- **缺点**：该值需要根据用户的显卡手动设置，对于代码分发和不同用户使用来说不够灵活。

### 方案B：更新 `runtime` 环境（高风险）

- **操作**：手动升级 `runtime` 文件夹内的 `torch`, `torchaudio` 等核心库到最新版本。
- **优点**：如果成功，可以一劳永逸地解决兼容性问题。
- **缺点**：风险极高。项目依赖复杂，随意升级核心库极有可能破坏依赖关系，导致整个项目无法运行。不推荐轻易尝试。

### 方案C：在UI上添加兼容性选项（当前采用的灵活方案）

- **操作**：在Gradio UI界面上，添加两个独立的复选框，将控制权交给用户。
  1.  **“半精度(FP16)推理”**：默认勾选。允许用户手动关闭半精度，切换到兼容性更好的全精度（FP32）模式，以解决“现象一”的报错。
  2.  **“启用v2Pro声纹”**：默认勾选。允许用户手动禁用 `eres2net` 模块，以解决“现象二”的报错。
- **优点**：最灵活、最安全。用户可以根据自己遇到的具体问题，精确地调整程序行为，在不修改环境的情况下找到一个可以稳定运行的配置。
- **缺点**：这是一种“绕过”而不是“解决”底层环境问题的方案。在禁用功能时，会牺牲部分性能（关闭半精度）或影响部分模型的音色相似度（关闭v2Pro声纹）。

**结论**：我们选择实施**方案C**，因为它为最终用户提供了最大的灵活性和最强的容错能力。